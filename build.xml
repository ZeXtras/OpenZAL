<project name="ZAL" basedir="." default="help">


  <taskdef name="preprocess" classname="com.objfac.prebop.ant.PreprocessorTask">
    <classpath>
      <pathelement location="ant/preprocessor.jar"/>
    </classpath>
  </taskdef>
  <taskdef resource="net/sf/antcontrib/antlib.xml">
    <classpath>
      <pathelement location="ant/ant-contrib-1.0b3.jar"/>
    </classpath>
  </taskdef>

  <description>Zimbra Abstraction Layer</description>

  <property name="src" location="src/java"/>
  <property name="itbase" location="tests/java/"/>

  <property name="COMPILER_ARGS" value="-Xlint"/>

  <path id="libraries">
    <fileset dir="lib" >
      <include name="*.jar"/>
    </fileset>
  </path>

  <target name="init">
    <tstamp />
    <echo> Building ZAL version 1.10.5 </echo>
    <exec executable="./gen_buildinfo.sh" failonerror="true" />
  </target>

  <macrodef name="build-zal">
     <attribute name="ZimbraVersion"/>
     <attribute name="MajorZimbraVersion"/>
     <attribute name="MiddleZimbraVersion"/>
     <attribute name="MinorZimbraVersion"/>

     <sequential>
       <local name="tmpsrc"/>
       <local name="build"/>
       <local name="dist"/>
       <property name="tmpsrc"  value="tmpsrc/@{ZimbraVersion}/jar/" />
       <property name="build" value="build/@{ZimbraVersion}/jar/" />
       <property name="dist"  value="dist/@{ZimbraVersion}/"/>

       <mkdir dir="${tmpsrc}"/>
       <mkdir dir="${build}"/>
       <mkdir dir="${dist}"/>

       <echo>Creating zal JAR for zimbra @{ZimbraVersion} ...</echo>

       <echo>Preprocessing...</echo>
       <preprocess indir="${src}" outdir="${tmpsrc}" out="replace" >
         <var name="ZimbraVersion" value="@{MajorZimbraVersion}.@{MiddleZimbraVersion}.@{MinorZimbraVersion}" />
         <var name="MajorZimbraVersion"  value="@{MajorZimbraVersion}" />
         <var name="MiddleZimbraVersion" value="@{MiddleZimbraVersion}" />
         <var name="MinorZimbraVersion"  value="@{MinorZimbraVersion}" />
         <filetype commentend="*/" commentbegin="/*" extensions="java"/>
       </preprocess>

       <javac includeantruntime="false" debug="true" debuglevel="lines,vars,source" srcdir="${tmpsrc}/" destdir="${build}/" target="1.6" source="1.6">
         <classpath>
           <path>
             <fileset dir="zimbra-jars/zimbra-jars-@{ZimbraVersion}/" >
               <include name="*.jar"/>
             </fileset>
           </path>
           <path refid="libraries" />
           <pathelement path="${build}" />
         </classpath>
         <compilerarg value="-Xlint:none" />
       </javac>
       <delete dir="${tmpsrc}/"/>

       <jar jarfile="${dist}/zal.jar.unsigned" compress="false">
         <manifest>
           <attribute name="Specification-Title" value="Zimbra Abstraction Layer" />
           <attribute name="Specification-Version" value="1.10.5" />
           <attribute name="Specification-Vendor" value="ZeXtras" />
           <attribute name="Implementation-Version" value="@{ZimbraVersion}" />
           <attribute name="Created-By" value="ZeXtras" />
           <attribute name="Zimbra-Extension-Class" value="org.openzal.zal.extension.ZalEntrypointImpl" />
         </manifest>
         <fileset dir="${build}" />
       </jar>

       <java dir="." fork="true" classname="org.openzal.zal.tools.ChecksumWriter">
         <classpath>
           <pathelement location="${dist}/zal.jar.unsigned" />
         </classpath>
         <arg value="private/key.pkcs8" />
         <arg value="${dist}/zal.jar.unsigned" />
         <arg value="${dist}/zal.jar" />
       </java>

       <delete file="${dist}/zal.jar.unsigned" />
    </sequential>
  </macrodef>

  <macrodef name="build-zal-itbase">
    <attribute name="ZimbraVersion"/>
    <attribute name="MajorZimbraVersion"/>
    <attribute name="MiddleZimbraVersion"/>
    <attribute name="MinorZimbraVersion"/>

    <sequential>
      <local name="itbase_tmpsrc"/>
      <local name="itbase_build"/>
      <local name="dist"/>
      <property name="itbase_tmpsrc"  value="tmpsrc/@{ZimbraVersion}/itbase/" />
      <property name="itbase_build" value="build/@{ZimbraVersion}/itbase/" />
      <property name="dist"  value="dist/@{ZimbraVersion}/"/>

      <mkdir dir="${itbase_tmpsrc}"/>
      <mkdir dir="${itbase_build}"/>

      <echo>Preprocessing ZAL test library...</echo>
      <preprocess indir="${itbase}" outdir="${itbase_tmpsrc}" out="replace" >
        <var name="ZimbraVersion" value="@{MajorZimbraVersion}.@{MiddleZimbraVersion}.@{MinorZimbraVersion}" />
        <var name="MajorZimbraVersion"  value="@{MajorZimbraVersion}" />
        <var name="MiddleZimbraVersion" value="@{MiddleZimbraVersion}" />
        <var name="MinorZimbraVersion"  value="@{MinorZimbraVersion}" />
        <filetype commentend="*/" commentbegin="/*" extensions="java"/>
      </preprocess>

      <javac includeantruntime="false" debug="true" debuglevel="lines,vars,source" srcdir="${itbase_tmpsrc}" destdir="${itbase_build}/" target="1.6" source="1.6">
        <classpath>
          <path>
            <fileset dir="../build-commons/zimbra-jars/zimbra-jars-@{ZimbraVersion}/" >
              <include name="*.jar"/>
            </fileset>
          </path>
          <path refid="libraries" />
          <pathelement location="${dist}/zal.jar" />
          <pathelement location="../dist/zextras.jar" />
          </classpath>
        <compilerarg value="-Xlint:none" />
      </javac>

      <delete dir="${itbase_tmpsrc}/"/>

      <jar jarfile="${dist}/zal-itbase.jar" compress="false">
        <manifest>
          <attribute name="Specification-Title" value="Zimbra Abstraction Layer" />
          <attribute name="Specification-Version" value="1.10.5" />
          <attribute name="Specification-Vendor" value="ZeXtras" />
          <attribute name="Implementation-Version" value="@{ZimbraVersion}" />
          <attribute name="Created-By" value="ZeXtras" />
        </manifest>
        <fileset dir="${itbase_build}" />
      </jar>
    </sequential>
  </macrodef>

<target name="zal-6.0.7"
        description="Create jar for Zimbra 6.0.7"
        depends="init">
  <build-zal ZimbraVersion="6.0.7"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "7" />
</target>
<target name="zal-6.0.8"
        description="Create jar for Zimbra 6.0.8"
        depends="init">
  <build-zal ZimbraVersion="6.0.8"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "8" />
</target>
<target name="zal-6.0.9"
        description="Create jar for Zimbra 6.0.9"
        depends="init">
  <build-zal ZimbraVersion="6.0.9"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "9" />
</target>
<target name="zal-6.0.10"
        description="Create jar for Zimbra 6.0.10"
        depends="init">
  <build-zal ZimbraVersion="6.0.10"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "10" />
</target>
<target name="zal-6.0.12"
        description="Create jar for Zimbra 6.0.12"
        depends="init">
  <build-zal ZimbraVersion="6.0.12"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "12" />
</target>
<target name="zal-6.0.13"
        description="Create jar for Zimbra 6.0.13"
        depends="init">
  <build-zal ZimbraVersion="6.0.13"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "13" />
</target>
<target name="zal-6.0.14"
        description="Create jar for Zimbra 6.0.14"
        depends="init">
  <build-zal ZimbraVersion="6.0.14"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "14" />
</target>
<target name="zal-6.0.15"
        description="Create jar for Zimbra 6.0.15"
        depends="init">
  <build-zal ZimbraVersion="6.0.15"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "15" />
</target>
<target name="zal-6.0.16"
        description="Create jar for Zimbra 6.0.16"
        depends="init">
  <build-zal ZimbraVersion="6.0.16"
             MajorZimbraVersion = "6"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "16" />
</target>
<target name="zal-7.0.0"
        description="Create jar for Zimbra 7.0.0"
        depends="init">
  <build-zal ZimbraVersion="7.0.0"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "0" />
</target>
<target name="zal-7.0.1"
        description="Create jar for Zimbra 7.0.1"
        depends="init">
  <build-zal ZimbraVersion="7.0.1"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "1" />
</target>
<target name="zal-7.1.0"
        description="Create jar for Zimbra 7.1.0"
        depends="init">
  <build-zal ZimbraVersion="7.1.0"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "1"
             MinorZimbraVersion = "0" />
</target>
<target name="zal-7.1.1"
        description="Create jar for Zimbra 7.1.1"
        depends="init">
  <build-zal ZimbraVersion="7.1.1"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "1"
             MinorZimbraVersion = "1" />
</target>
<target name="zal-7.1.2"
        description="Create jar for Zimbra 7.1.2"
        depends="init">
  <build-zal ZimbraVersion="7.1.2"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "1"
             MinorZimbraVersion = "2" />
</target>
<target name="zal-7.1.3"
        description="Create jar for Zimbra 7.1.3"
        depends="init">
  <build-zal ZimbraVersion="7.1.3"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "1"
             MinorZimbraVersion = "3" />
</target>
<target name="zal-7.1.4"
        description="Create jar for Zimbra 7.1.4"
        depends="init">
  <build-zal ZimbraVersion="7.1.4"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "1"
             MinorZimbraVersion = "4" />
</target>
<target name="zal-7.2.0"
        description="Create jar for Zimbra 7.2.0"
        depends="init">
  <build-zal ZimbraVersion="7.2.0"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "0" />
</target>
<target name="zal-7.2.1"
        description="Create jar for Zimbra 7.2.1"
        depends="init">
  <build-zal ZimbraVersion="7.2.1"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "1" />
</target>
<target name="zal-7.2.2"
        description="Create jar for Zimbra 7.2.2"
        depends="init">
  <build-zal ZimbraVersion="7.2.2"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "2" />
</target>
<target name="zal-7.2.3"
        description="Create jar for Zimbra 7.2.3"
        depends="init">
  <build-zal ZimbraVersion="7.2.3"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "3" />
</target>
<target name="zal-7.2.4"
        description="Create jar for Zimbra 7.2.4"
        depends="init">
  <build-zal ZimbraVersion="7.2.4"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "4" />
</target>
<target name="zal-7.2.5"
        description="Create jar for Zimbra 7.2.5"
        depends="init">
  <build-zal ZimbraVersion="7.2.5"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "5" />
</target>
<target name="zal-7.2.6"
        description="Create jar for Zimbra 7.2.6"
        depends="init">
  <build-zal ZimbraVersion="7.2.6"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "6" />
</target>
<target name="zal-7.2.7"
        description="Create jar for Zimbra 7.2.7"
        depends="init">
  <build-zal ZimbraVersion="7.2.7"
             MajorZimbraVersion = "7"
             MiddleZimbraVersion = "2"
             MinorZimbraVersion = "7" />
</target>
<target name="zal-8.0.0"
        description="Create jar for Zimbra 8.0.0"
        depends="init">
  <build-zal ZimbraVersion="8.0.0"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "0" />
</target>
<target name="zal-8.0.1"
        description="Create jar for Zimbra 8.0.1"
        depends="init">
  <build-zal ZimbraVersion="8.0.1"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "1" />
</target>
<target name="zal-8.0.2"
        description="Create jar for Zimbra 8.0.2"
        depends="init">
  <build-zal ZimbraVersion="8.0.2"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "2" />
</target>
<target name="zal-8.0.3"
        description="Create jar for Zimbra 8.0.3"
        depends="init">
  <build-zal ZimbraVersion="8.0.3"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "3" />
</target>
<target name="zal-8.0.4"
        description="Create jar for Zimbra 8.0.4"
        depends="init">
  <build-zal ZimbraVersion="8.0.4"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "4" />
</target>
<target name="zal-8.0.5"
        description="Create jar for Zimbra 8.0.5"
        depends="init">
  <build-zal ZimbraVersion="8.0.5"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "5" />
</target>
<target name="zal-8.0.6"
        description="Create jar for Zimbra 8.0.6"
        depends="init">
  <build-zal ZimbraVersion="8.0.6"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "6" />
</target>
<target name="zal-8.0.7"
        description="Create jar for Zimbra 8.0.7"
        depends="init">
  <build-zal ZimbraVersion="8.0.7"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "7" />
</target>
<target name="zal-8.0.8"
        description="Create jar for Zimbra 8.0.8"
        depends="init">
  <build-zal ZimbraVersion="8.0.8"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "8" />
</target>
<target name="zal-8.0.9"
        description="Create jar for Zimbra 8.0.9"
        depends="init">
  <build-zal ZimbraVersion="8.0.9"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "0"
             MinorZimbraVersion = "9" />
</target>
<target name="zal-8.5.0"
        description="Create jar for Zimbra 8.5.0"
        depends="init">
  <build-zal ZimbraVersion="8.5.0"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "5"
             MinorZimbraVersion = "0" />
</target>
<target name="zal-8.5.1"
        description="Create jar for Zimbra 8.5.1"
        depends="init">
  <build-zal ZimbraVersion="8.5.1"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "5"
             MinorZimbraVersion = "1" />
</target>
<target name="zal-8.6.0"
        description="Create jar for Zimbra 8.6.0"
        depends="init">
  <build-zal ZimbraVersion="8.6.0"
             MajorZimbraVersion = "8"
             MiddleZimbraVersion = "6"
             MinorZimbraVersion = "0" />
</target>

  <target name="zal-common" depends="zal-6.0.7,zal-6.0.16,zal-7.0.0,zal-7.2.7,zal-8.0.0,zal-8.0.9,zal-8.6.0" />
  <target name="zal-all" depends="zal-6.0.7,zal-6.0.8,zal-6.0.9,zal-6.0.10,zal-6.0.12,zal-6.0.13,zal-6.0.14,zal-6.0.15,zal-6.0.16,zal-7.0.0,zal-7.0.1,zal-7.1.0,zal-7.1.1,zal-7.1.2,zal-7.1.3,zal-7.1.4,zal-7.2.0,zal-7.2.1,zal-7.2.2,zal-7.2.3,zal-7.2.4,zal-7.2.5,zal-7.2.6,zal-7.2.7,zal-8.0.0,zal-8.0.1,zal-8.0.2,zal-8.0.3,zal-8.0.4,zal-8.0.5,zal-8.0.6,zal-8.0.7,zal-8.0.8,zal-8.0.9,zal-8.5.0,zal-8.5.1,zal-8.6.0" />

  <target name="clean" description="clean up" >
    <delete includeemptydirs="true">
      <fileset dir="dist/" includes="**/*" />
      <fileset dir="build/" includes="**/*" />
      <fileset dir="tmpsrc/" includes="**/*" />
      <fileset dir="." includes="*.deb" />
      <fileset dir="." includes="*.rpm" />
    </delete>
  </target>

  <target name="doxygen" description="create doxygen documentation" >
    <exec executable="doxygen" />
  </target>

  <macrodef name="prepare-build-template">
    <attribute name="srcFile"/>
    <attribute name="destFile"/>

    <sequential>
      <copy file="@{srcFile}"
            tofile="@{destFile}"/>
      <replace file="@{destFile}">
        <replacefilter
          token="@VERSION@"
          value="1.10.5"/>
        <replacefilter
          token="@VERSION_MAJOR@"
          value="1"/>
        <replacefilter
          token="@VERSION_MINOR@"
          value="10"/>
        <replacefilter
          token="@VERSION_MICRO@"
          value="5"/>
        <replacefilter
          token="@FIRST_ZIMBRA_VERSION@"
          value="6.0.7"/>
        <replacefilter
          token="@LAST_ZIMBRA_VERSION@"
          value="8.6.0"/>
      </replace>
    </sequential>
  </macrodef>

  <target name="package-deb"
          depends="clean, zal-all">
    <local name="deb-dir-tmp"/>
    <property name="deb-dir-tmp" location="deb"/>

    <delete dir="${deb-dir-tmp}"/>

    <mkdir dir="${deb-dir-tmp}"/>
    <mkdir dir="${deb-dir-tmp}/openzal-1.10"/>
    <mkdir dir="${deb-dir-tmp}/openzal-1.10/usr/share/openzal/1.10"/>
    <mkdir dir="${deb-dir-tmp}/openzal-1.10/usr/share/doc/openzal-1.10"/>
    <mkdir dir="${deb-dir-tmp}/openzal-1.10/DEBIAN"/>

    <prepare-build-template srcFile="tools/deb_control_template"
                            destFile="${deb-dir-tmp}/openzal-1.10/DEBIAN/control" />

    <copy todir="${deb-dir-tmp}/openzal-1.10/usr/share/openzal/1.10">
      <fileset dir="dist">
        <include name="**/zal.jar"/>
      </fileset>
    </copy>

    <copy file="tools/deb_copyright"
        tofile="${deb-dir-tmp}/openzal-1.10/usr/share/doc/openzal-1.10/copyright"/>

    <exec executable="dpkg-deb"
          dir="${deb-dir-tmp}"
          failonerror="true">
      <arg value="--build"/>
      <arg value="openzal-1.10"/>
    </exec>
    <move file="${deb-dir-tmp}/openzal-1.10.deb" todir="." />

    <delete dir="${deb-dir-tmp}"/>
  </target>

  <target name="package-rpm"
          depends="clean, zal-all">
    <local name="rpm-dir-tmp"/>
    <property name="rpm-dir-tmp" location="rpm"/>

    <delete dir="${rpm-dir-tmp}"/>

    <mkdir dir="${rpm-dir-tmp}"/>
    <mkdir dir="${rpm-dir-tmp}/openzal-1.10"/>
    <mkdir dir="${rpm-dir-tmp}/openzal-1.10/buildroot/usr/share/openzal/1.10"/>
    <mkdir dir="${rpm-dir-tmp}/openzal-1.10/SPEC"/>
    <mkdir dir="${rpm-dir-tmp}/openzal-1.10/RPMS"/>

    <prepare-build-template srcFile="tools/rpm_spec_template"
                            destFile="${rpm-dir-tmp}/openzal-1.10/SPEC/openzal-1.10.spec" />

    <copy todir="${rpm-dir-tmp}/openzal-1.10/buildroot/usr/share/openzal/1.10">
      <fileset dir="dist">
        <include name="**/zal.jar"/>
      </fileset>
    </copy>

    <exec executable="rpmbuild"
          dir="${rpm-dir-tmp}"
          failonerror="true">
      <arg value="-bb"/>
      <arg value="--buildroot"/><arg value="${rpm-dir-tmp}/openzal-1.10/buildroot"/>
      <arg value="openzal-1.10/SPEC/openzal-1.10.spec"/>
    </exec>
    <move file="${rpm-dir-tmp}/openzal-1.10/RPMS/noarch/openzal-1.10-5-0.noarch.rpm" todir="." />

    <delete dir="${rpm-dir-tmp}"/>
  </target>

  <target name="package"
    depends="package-deb, package-rpm">
  </target>

  <target name="help">
    <echo>commands availables are:
      zal-all
      zal-common
      zal-{zimbra-version}
      clean
      doxygen
      package-rpm
      package-deb
      package
      help
    </echo>
  </target>

</project>

